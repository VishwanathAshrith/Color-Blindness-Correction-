<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Live Camera Correction - Color Vision Enhancement</title>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #e8f8f5 0%, #d4f1f4 100%);
      min-height: 100vh;
      padding: 20px;
    }

    /* Header */
    .header {
      background: linear-gradient(135deg, #4db8b3 0%, #3da8a3 100%);
      color: white;
      padding: 18px 30px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin: -20px -20px 30px -20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header-title {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 20px;
      font-weight: 600;
    }

    .header-icon {
      font-size: 24px;
    }

    .home-btn {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: none;
      padding: 10px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 15px;
      font-weight: 500;
      transition: background 0.3s ease;
    }

    .home-btn:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    /* Main Container */
    .container {
      max-width: 1100px;
      margin: 0 auto;
    }

    /* Main Card */
    .main-card {
      background: white;
      border-radius: 20px;
      padding: 50px 60px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    }

    .page-title {
      font-size: 32px;
      font-weight: 700;
      color: #2c3e50;
      margin-bottom: 15px;
      text-align: center;
    }

    .deficiency-info {
      text-align: center;
      color: #7f8c8d;
      font-size: 16px;
      margin-bottom: 40px;
    }

    .deficiency-type {
      font-weight: 600;
      color: #4db8b3;
    }

    /* Steps */
    .steps-container {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      margin-bottom: 50px;
    }

    .step-card {
      background: linear-gradient(135deg, #e8f8f5 0%, #d4f1f4 50%);
      border-radius: 16px;
      padding: 30px 20px;
      text-align: center;
      position: relative;
    }

    .step-number {
      width: 45px;
      height: 45px;
      background: linear-gradient(135deg, #4db8b3 0%, #3da8a3 100%);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      font-weight: 700;
      margin: 0 auto 15px;
      box-shadow: 0 4px 12px rgba(77, 184, 179, 0.3);
    }

    .step-text {
      color: #34495e;
      font-size: 15px;
      font-weight: 500;
      line-height: 1.5;
    }

    /* Camera Section */
    .camera-section {
      background: linear-gradient(135deg, #f8fdfd 0%, #f0f9f9 100%);
      border-radius: 20px;
      padding: 40px;
      margin-bottom: 40px;
      border: 2px dashed #b8e6e3;
      text-align: center;
    }

    .camera-icon {
      font-size: 48px;
      margin-bottom: 20px;
    }

    video {
      width: 100%;
      max-width: 500px;
      border-radius: 16px;
      border: 3px solid #cceee8;
      box-shadow: 0 4px 16px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      background: #000;
    }

    .camera-info {
      color: #7f8c8d;
      font-size: 14px;
      margin-bottom: 25px;
    }

    .capture-btn {
      background: linear-gradient(135deg, #4db8b3 0%, #3da8a3 100%);
      color: white;
      border: none;
      padding: 16px 40px;
      border-radius: 12px;
      font-size: 17px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(77, 184, 179, 0.3);
      transition: all 0.3s ease;
    }

    .capture-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(77, 184, 179, 0.4);
    }

    .capture-btn:active {
      transform: translateY(0);
    }

    canvas {
      display: none;
    }

    /* Results Section */
    .results-section {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      margin-top: 40px;
    }

    .result-card {
      background: white;
      border-radius: 16px;
      padding: 25px;
      border: 2px solid #e8f8f5;
      box-shadow: 0 2px 12px rgba(0,0,0,0.05);
    }

    .result-card h3 {
      color: #4db8b3;
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 20px;
      text-align: center;
    }

    .result-image-container {
      min-height: 200px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f8fdfd;
      border-radius: 12px;
      border: 2px dashed #d4f1f4;
    }

    .result-image-container img {
      width: 100%;
      border-radius: 12px;
      border: none;
    }

    .placeholder-text {
      color: #95a5a6;
      font-size: 14px;
      font-style: italic;
    }

    /* Loading State */
    .loading {
      display: none;
      text-align: center;
      margin-top: 20px;
    }

    .loading.active {
      display: block;
    }

    .spinner {
      border: 4px solid #e8f8f5;
      border-top: 4px solid #4db8b3;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loading-text {
      color: #7f8c8d;
      font-size: 15px;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .main-card {
        padding: 30px 25px;
      }

      .steps-container {
        grid-template-columns: 1fr;
      }

      .results-section {
        grid-template-columns: 1fr;
      }

      .page-title {
        font-size: 26px;
      }

      .header {
        flex-direction: column;
        gap: 15px;
        text-align: center;
      }
    }
  </style>
</head>

<body>

  <!-- Header -->
  <div class="header">
    <div class="header-title">
      <span class="header-icon">üñºÔ∏è</span>
      Image Color Correction
    </div>
    <button class="home-btn" onclick="window.location.href='/'">Home</button>
  </div>

  <!-- Main Container -->
  <div class="container">
    <div class="main-card">
      
      <!-- Title -->
      <h1 class="page-title">Live Camera Color Enhancement</h1>
      
      <!-- Deficiency Info -->
      <p class="deficiency-info">
        Selected deficiency: <span class="deficiency-type" id="typeLabel"></span>
      </p>

      <!-- Steps -->
      <div class="steps-container">
        <div class="step-card">
          <div class="step-number">1</div>
          <div class="step-text">Enable camera access</div>
        </div>
        <div class="step-card">
          <div class="step-number">2</div>
          <div class="step-text">Capture the live frame</div>
        </div>
        <div class="step-card">
          <div class="step-number">3</div>
          <div class="step-text">View corrected result</div>
        </div>
      </div>

      <!-- Camera Section -->
      <div class="camera-section">
        <div class="camera-icon">üìπ</div>
        <video id="video" autoplay playsinline></video>
        <div class="camera-info">
          Position your camera to capture the image you want to correct
        </div>
        <button class="capture-btn" onclick="capture()">
          üì∏ Capture & Correct
        </button>
      </div>

      <!-- Loading State -->
      <div class="loading" id="loading">
        <div class="spinner"></div>
        <div class="loading-text">Processing your image...</div>
      </div>

      <!-- Canvas (hidden) -->
      <canvas id="canvas"></canvas>

      <!-- Results Section -->
      <div class="results-section" id="resultsSection" style="display: none;">
        <div class="result-card">
          <h3>Original Frame</h3>
          <div class="result-image-container">
            <img id="originalImage" alt="Original frame">
          </div>
        </div>
        <div class="result-card">
          <h3>Corrected Image</h3>
          <div class="result-image-container">
            <img id="resultImage" alt="Corrected frame">
          </div>
        </div>
      </div>

    </div>
  </div>

<script>
  // =========================
  // READ TYPE FROM URL
  // =========================
  const params = new URLSearchParams(window.location.search);
  const blindnessType = params.get("type") || "protanopia";
  document.getElementById("typeLabel").innerText = blindnessType;

  // =========================
  // START CAMERA
  // =========================
  const video = document.getElementById("video");
  navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
    .then(stream => video.srcObject = stream)
    .catch(err => {
      alert("Camera access denied. Please enable camera permissions.");
      console.error(err);
    });

  // =========================
  // CAPTURE FRAME + SEND
  // =========================
  function capture() {
    const canvas = document.getElementById("canvas");
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;

    const ctx = canvas.getContext("2d");
    ctx.drawImage(video, 0, 0);

    // Show original image
    const originalImg = document.getElementById("originalImage");
    originalImg.src = canvas.toDataURL("image/jpeg");

    // Show loading
    document.getElementById("loading").classList.add("active");
    document.getElementById("resultsSection").style.display = "none";

    canvas.toBlob(blob => {
      const fd = new FormData();
      fd.append("image", blob, "camera.jpg");
      fd.append("type", blindnessType);

      fetch("/generate", {
        method: "POST",
        body: fd
      })
      .then(res => res.json())
      .then(data => {
        // Hide loading
        document.getElementById("loading").classList.remove("active");

        if (data.error) {
          alert(data.error);
          return;
        }

        // Find matching output
        const match = data.output_images.find(name =>
          name.includes(blindnessType)
        );

        if (!match) {
          alert("No matching output found");
          return;
        }

        // Show results
        const img = document.getElementById("resultImage");
        img.src = "/output/" + match + "?t=" + Date.now();
        document.getElementById("resultsSection").style.display = "grid";

        // Smooth scroll to results
        setTimeout(() => {
          document.getElementById("resultsSection").scrollIntoView({ 
            behavior: 'smooth', 
            block: 'nearest' 
          });
        }, 100);
      })
      .catch(err => {
        document.getElementById("loading").classList.remove("active");
        alert("Error processing image: " + err.message);
        console.error(err);
      });
    }, "image/jpeg", 0.95);
  }
</script>

</body>
</html>